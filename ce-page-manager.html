<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../app-route/app-location.html">
<link rel="import" href="../app-route/app-route.html">
<link rel="import" href="../neon-animation/neon-animated-pages.html">

<link rel="import" href="../ce-json-file/ce-json-file.html">

<!--
`ce-page-manager`
Custom Element to help managing pages using polymer.

@demo demo/index.html 
-->

<dom-module id="ce-page-manager">
	<template>
		<style>
			:host {
				display: inline-block;

				width: 100%;
				height: 100%;
			}
			neon-animated-pages > section,
			neon-animated-pages > section > * {
				display: block;
			}
			section.iron-selected{
				position: relative;
			}
			section.neon-animating{
				position: relative;
			}
			section.iron-selected.neon-animating{
				position: absolute;
			}
		</style>
		
		<app-location route="{{_route}}"></app-location>
		
		<ce-json-file 
			path="[[siteMap]]" 
			json="{{siteObject}}">
		</ce-json-file>

		<neon-animated-pages 
			id="content" 
			attr-for-selected="data-name" 
			selected="[[_selectedPage]]"
			animation-config="[[animationConfig]]"
			entry-animation="[[entryAnimation]]"
			exit-animation="[[exitAnimation]]"
			animate-initial-selection="[[animateInitialSelection]]" 
			class="flex">
		</neon-animated-pages>
	</template>

	<script>
		Polymer({

			is: 'ce-page-manager',

			properties: {
				/**
				 * Fired when page changes.
				 *
				 * @event page-change
				 */

				/**
				 * Path to sitemap json file
				 */
				siteMap: {
					type: String,
					value: '/sitemap'
				},

				/**
				 * Sitemap object
				 * 
				 * Can be found from property `siteMap` or can be mannualy passed
				 */
				siteObject: {
					type: Object
				},

				/**
				 * Pages components directory
				 */
				pagesDir: {
					type: String,
					value: '/pages'
				},

				/**
				 * Initial path for manager
				 */
				initPath: {
					type: String,
					value: ''
				},

				/**
				 * Selected page string for neon-animated-page
				 */
				_selectedPage: {
					type: String
				},

				/**
				 * Route object from `app-location`
				 */
				_route: {
					type: Object
				},

				/**
				 * Animation configuration. 
				 * See PolymerElements/neon-animated-pages for more info.
				 */
				animationConfig: {
					type: Object
				},

				/**
				 * Convenience property for setting an 'entry' animation. 
				 * Do not set animationConfig.entry manually if using this. 
				 * The animated node is set to this if using this property.
				 */
				entryAnimation: {
					type: String
				},

				/**
				 * Convenience property for setting an 'exit' animation. 
				 * Do not set animationConfig.exit manually if using this. 
				 * The animated node is set to this if using this property.
				 */
				exitAnimation: {
					type: String
				},

				/**
				 * if true, the initial page selection will also be animated according to its animation config.
				 */
				animateInitialSelection: {
					type: Boolean,
					value: false
				}
			},

			observers: [
				'_changePage(_route)',
				'_changeSiteMap(siteObject)'
			],

			_changePage: function(){
				if(!this.siteObject){
					return
				}
				
				// get path from app-location
				var path = this._route.path.replace(/\//g, '-').substring(1)
				if(path[path.length - 1] == '-'){
					path = path.substring(0, path.length - 1)
				}

				// get selected section
				var section = this.$$('section[data-name="' + path + '"]')
				if(!section){
					var tmp_path = path.substring(this.initPath.length).split('-')
					var tmp_json = this.siteObject

					// finding where dynamic section is
					for(var i = 0; i < tmp_path.length; i++){
						if(typeof tmp_json === 'object' && tmp_path[i] in tmp_json){
							tmp_json = tmp_json[tmp_path[i]]
						}else{
							path = this.initPath.replace(/\//g, '-').substring(1) + '-' + tmp_path.slice(0, i).join('-') + '-*'
							tmp_path = tmp_path.slice(i)
							break
						}
					}

					// loading dynamic section
					section = this.$$('section[data-name="' + path + '"]')
					if(!section){
						console.log('No page found for [' + this._route.path + ']')
						return
					}
					section.children[0].query = tmp_path  
				}

				// lazy loads element
				var url = this.pagesDir + '/' + section.dataUrl + '.html'
				
				this.importHref(
					url, 
					() => {
						this.set('_selectedPage', path)

						this.fire('page-change', {
							path: this._route.path
						})
					},
					() => {
						console.log('No element found for [' + url + ']')
					},
					true
				)
			},

			_changeSiteMap: function(){
				this._loadElements(this.siteObject, this.initPath)
				this._changePage()
			},

			/**
			 * Recusrive function to load elements from a json object
			 * 
			 * @param json {path: element} - json object to generate elements
			 * @param path - initial path to add objects
			 */
			_loadElements: function(json, path){
				for(key in json){
					// iterate again, found a dict
					if(typeof json[key] == 'object'){
						this._loadElements(json[key], path + '/' + key)
					}
					// it's a path, found a string
					else{
						var el = document.createElement(json[key])
						var section = document.createElement('section')
						section.dataUrl = json[key]

						if(!key){
							section.setAttribute('data-name', path.replace(/\//g, '-').substring(1))
						}else if(key === '*'){
							section.setAttribute('data-name', (path.replace(/\//g, '-') + '-').substring(1) + key)
						}else{
							section.setAttribute('data-name', (path.replace(/\//g, '-') + '-').substring(1) + key)
						}

						section.appendChild(el)
						Polymer.dom(this.$.content).appendChild(section)
					}
				}
			}

		});
	</script>
</dom-module>
